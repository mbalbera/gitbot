from fastapi import FastAPI, File, UploadFile
from docx import Document
import json
from typing import List, Dict

app = FastAPI()

def parse_docx(file_path: str) -> Dict:
    """Extract text and tables from a Word document and return as JSON."""
    doc = Document(file_path)
    
    # Extract text
    text_content = [para.text for para in doc.paragraphs if para.text.strip()]

    # Extract tables
    tables = []
    for table in doc.tables:
        table_data = []
        for row in table.rows:
            table_data.append([cell.text.strip() for cell in row.cells])
        tables.append(table_data)

    return {
        "text": text_content,
        "tables": tables
    }

@app.post("/upload-doc/")
async def upload_doc(file: UploadFile = File(...)):
    """API endpoint to receive a Word document, extract content, and return JSON."""
    file_path = f"temp_{file.filename}"
    
    # Save the uploaded file
    with open(file_path, "wb") as buffer:
        buffer.write(file.file.read())

    # Parse the document
    doc_content = parse_docx(file_path)

    return {"filename": file.filename, "content": doc_content}
